@page "/lock"
@using jornAPP.Services
@inject SecurityService SecurityService
@inject NavigationManager Nav

<!--  MAIN LOCK CONTAINER -->
<div class="lock-container">
    <h2>Unlock Journal Ô∏è</h2>

    @if (isLoading)
    {
        <!-- Show while checking if a user exists -->
        <p class="loading">Loading...</p>
    }
    else
    {
        @if (!hasExistingUser)
        {
            <!-- Show if no user/journal is set up -->
            <p class="info-text">No journal found. Please create a new journal first.</p>
            <button class="btn-primary" @onclick="GoToSetup">Create Journal</button>
        }
        else
        {
            <!-- Login inputs -->
            <input class="input-field" placeholder="Username" @bind="username" />
            <input class="input-field" placeholder="Password" type="password" @bind="password" />
            <button class="btn-primary" @onclick="Unlock">Unlock</button>

            <!-- Error message -->
            <p class="error">@message</p>

            <hr class="divider"/>
            <!-- Option to reset journal -->
            <button class="btn-secondary" @onclick="CreateNewJournal">Create New Journal</button>
        }
    }
</div>

<!--  STYLING -->
<style>
.lock-container {
    max-width: 450px;
    margin: 80px auto;
    padding: 30px;
    background: #1e1e1e; /* Dark background for lock screen */
    border-radius: 12px;
    box-shadow: 0 10px 25px rgba(0,0,0,0.6);
    text-align: center;
}

h2 {
    font-size: 1.8rem;
    margin-bottom: 25px;
    color: #ffdd57; /* Gold title color */
}

.loading {
    font-size: 1rem;
    color: #aaaaaa;
}

.info-text {
    font-size: 1rem;
    margin-bottom: 20px;
}

.input-field {
    width: 100%;
    padding: 12px 15px;
    margin: 10px 0;
    border-radius: 8px;
    border: none;
    background: #2a2a2a;
    color: #ffffff;
    font-size: 1rem;
}

.input-field::placeholder {
    color: #aaaaaa;
}

/* BUTTONS */
.btn-primary, .btn-secondary {
    width: 100%;
    padding: 12px;
    margin-top: 15px;
    border: none;
    border-radius: 8px;
    font-size: 1rem;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s ease-in-out;
}

.btn-primary {
    background: #ffdd57;
    color: #121212;
}
.btn-primary:hover {
    opacity: 0.85;
    transform: translateY(-2px);
}

.btn-secondary {
    background: #444444;
    color: #ffffff;
}
.btn-secondary:hover {
    background: #555555;
    transform: translateY(-2px);
}

/* ERROR MESSAGE */
.error {
    color: #ff4c4c;
    margin-top: 12px;
}

/* DIVIDER LINE */
.divider {
    margin: 25px 0;
    border-color: #2a2a2a;
}
</style>

@code {
    //  Form fields
    string username = "";
    string password = "";
    string message = "";

    //  Loading and user state
    bool isLoading = true;
    bool hasExistingUser = false;

    //  Check if user exists on page load
    protected override async Task OnInitializedAsync()
    {
        hasExistingUser = await SecurityService.IsUserRegisteredAsync();
        isLoading = false;
    }

    //  Navigate to setup page if no journal exists
    void GoToSetup()
    {
        Nav.NavigateTo("/", true);
    }

    //  Attempt to unlock journal
    async Task Unlock()
    {
        var success = await SecurityService.LoginAsync(username, password);

        if (success)
        {
            Nav.NavigateTo("/home", true); // Successful login -> home
        }
        else
        {
            message = "Invalid credentials"; // Show error
        }
    }

    //  Create a completely new journal (resets user)
    async Task CreateNewJournal()
    {
        await SecurityService.DeleteAllUsersAsync(); // Delete all user data
        Nav.NavigateTo("/", true); // Navigate to setup
    }
}
