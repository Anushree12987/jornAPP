@page "/"
@using jornAPP.Services
@inject SecurityService SecurityService
@inject NavigationManager Nav

<!-- ================= SETUP CONTAINER ================= -->
<div class="setup-container">
    <h2>Welcome to JournalApp </h2>

    @if (isLoading)
    {
        <!-- Show loading text while checking if a user exists -->
        <p class="loading">Loading...</p>
    }
    else
    {
        @if (hasExistingUser)
        {
            <!-- If a user/journal already exists -->
            <p class="info-text">You already have a journal.</p>
            <div class="button-group">
                <!-- Option to unlock existing journal -->
                <button class="btn-primary" @onclick="GoToLock">Unlock Existing Journal</button>
                <!-- Option to create a completely new journal (deletes old users) -->
                <button class="btn-secondary" @onclick="CreateNewJournal">Create New Journal</button>
            </div>
        }
        else
        {
            <!-- Input fields for new user registration -->
            <input class="input-field" placeholder="Username" @bind="username" />
            <input class="input-field" placeholder="Create Password" type="password" @bind="password" />
            <button class="btn-primary" @onclick="Register">Create Journal</button>
            <!-- Display error messages -->
            <p class="error">@message</p>
        }
    }
</div>

<style>
/* ================= CONTAINER STYLING ================= */
.setup-container {
    max-width: 450px;
    margin: 80px auto;
    padding: 30px;
    background: #1e1e1e;
    border-radius: 12px;
    box-shadow: 0 10px 25px rgba(0,0,0,0.6);
    text-align: center;
}

/* Header styling */
h2 {
    font-size: 1.8rem;
    margin-bottom: 25px;
    color: #ffdd57;
}

/* Loading text */
.loading {
    font-size: 1rem;
    color: #aaaaaa;
}

/* Info text for existing journal */
.info-text {
    font-size: 1rem;
    margin-bottom: 20px;
}

/* Input fields */
.input-field {
    width: 100%;
    padding: 12px 15px;
    margin: 10px 0;
    border-radius: 8px;
    border: none;
    background: #2a2a2a;
    color: #ffffff;
    font-size: 1rem;
}

/* Placeholder text */
.input-field::placeholder {
    color: #aaaaaa;
}

/* Buttons styling */
.btn-primary, .btn-secondary {
    width: 100%;
    padding: 12px;
    margin-top: 15px;
    border: none;
    border-radius: 8px;
    font-size: 1rem;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s ease-in-out;
}

.btn-primary {
    background: #ffdd57;
    color: #121212;
}

.btn-primary:hover {
    opacity: 0.85;
    transform: translateY(-2px);
}

.btn-secondary {
    background: #444444;
    color: #ffffff;
}

.btn-secondary:hover {
    background: #555555;
    transform: translateY(-2px);
}

/* Error messages */
.error {
    color: #ff4c4c;
    margin-top: 12px;
}

/* Button group styling for multiple buttons */
.button-group {
    display: flex;
    justify-content: space-between;
    gap: 10px;
}
</style>

@code {
    // ================= VARIABLES =================
    string username = "";       // Stores username input
    string password = "";       // Stores password input
    string message = "";        // Displays registration errors
    bool isLoading = true;      // Loading flag while checking for existing user
    bool hasExistingUser = false; // Flag for existing user/journal

    // ================= INITIALIZATION =================
    protected override async Task OnInitializedAsync()
    {
        // Check if a journal/user already exists in the system
        hasExistingUser = await SecurityService.IsUserRegisteredAsync();
        isLoading = false; // Stop showing loading message
    }

    // ================= NAVIGATION METHODS =================

    // Navigate to the lock page to unlock existing journal
    void GoToLock()
    {
        Nav.NavigateTo("/lock", true);
    }

    // Create a completely new journal (deletes all existing users)
    async Task CreateNewJournal()
    {
        await SecurityService.DeleteAllUsersAsync(); // delete old users
        Nav.NavigateTo("/", true); // reload setup page for new registration
    }

    // ================= REGISTER NEW USER =================
    async Task Register()
    {
        // Validate inputs
        if (string.IsNullOrWhiteSpace(username) || string.IsNullOrWhiteSpace(password))
        {
            message = "All fields are required";
            return;
        }

        // Attempt registration via SecurityService
        var success = await SecurityService.RegisterAsync(username, password);

        if (success)
        {
            // On success, navigate to lock page
            Nav.NavigateTo("/lock", true);
        }
        else
        {
            // Show error if user already exists
            message = "User already exists";
        }
    }
}
