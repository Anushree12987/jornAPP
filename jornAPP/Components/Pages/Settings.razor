@page "/settings"
@using jornAPP.Components.Models
@using System.IO
@using Microsoft.Maui.Storage
@using System.Linq
@using jornAPP.Services
@inject ThemeService ThemeService
@inject SecurityService SecurityService
@inject EntryService EntryService
@inject PdfService PdfService
@inject JournalService JournalService

<h2>Settings Ô∏è</h2>

<!-- ================= THEME TOGGLE SECTION ================= -->
<div class="settings-section">
    <h3>Theme</h3>
    <!-- Toggle between Light and Dark mode -->
    <button class="btn-primary" @onclick="ToggleTheme">
        Switch to @(ThemeService.IsDark ? "Light" : "Dark") Mode
    </button>
</div>

<!-- ================= SECURITY SECTION ================= -->
<div class="settings-section">
    <h3>Security</h3>
    <!-- Input for new password -->
    <input class="input-field" placeholder="New Password" type="password" @bind="newPassword" />
    <button class="btn-primary" @onclick="ChangePassword">Change Password</button>
    <!-- Display success/error messages -->
    <p class="error">@securityMessage</p>
</div>

<!-- ================= EXPORT PDF SECTION ================= -->
<div class="settings-section">
    <h3>Export Journal</h3>

    <!-- Option to filter entries by date range -->
    <label>
        <input type="checkbox" @bind="useDataRange" /> Filter by date range
    </label>

    @if (useDataRange)
    {
        <!-- Date range inputs -->
        <label>From:</label>
        <input class="input-field" type="date" @bind="startDate" />
        <label>To:</label>
        <input class="input-field" type="date" @bind="endDate" />
    }

    <!-- Export button -->
    <button class="btn-primary" @onclick="ExportPdf">Export PDF</button>
    <!-- Display export status -->
    <p>@exportMessage</p>
</div>

<!-- ================= DELETE OLD ENTRIES SECTION ================= -->
<div class="settings-section">
    <h3>Delete Old Entries</h3>
    <!-- Button to delete orphaned/old entries -->
    <button class="btn-primary" @onclick="DeleteOrphanedEntries">üóëÔ∏è Delete Old Entries</button>
    <!-- Display deletion status -->
    <p>@deleteMessage</p>
</div>

<style>
/* ================= SECTIONS ================= */
.settings-section {
    margin: 20px 0;
    padding: 22px;
    background-color: var(--section-bg); /* section background (dark/light) */
    border-radius: 14px;
    box-shadow: 0 10px 25px rgba(0, 0, 0, 0.6);
    transition: transform 0.25s ease, box-shadow 0.25s ease;
}

.settings-section:hover {
    transform: translateY(-2px);
    box-shadow: 0 14px 35px rgba(0, 0, 0, 0.8);
}

.settings-section h3 {
    color: var(--accent-yellow);
    margin-bottom: 14px;
    font-size: 1.25rem;
    letter-spacing: 0.5px;
}

/* ================= INPUT FIELDS ================= */
.input-field {
    width: 100%;
    padding: 13px 16px;
    margin: 10px 0;
    border-radius: 10px;
    border: 1px solid #2a2a2a;
    background-color: var(--input-bg);
    color: var(--input-text);
    font-size: 1rem;
    transition: border 0.2s ease, box-shadow 0.2s ease;
}

.input-field::placeholder {
    color: #9a9a9a;
}

.input-field:focus {
    outline: none;
    border-color: var(--accent-yellow);
    box-shadow: 0 0 0 2px rgba(255, 212, 0, 0.25);
}

/* Error message styling */
.error {
    color: #ff5c5c;
    margin-top: 10px;
    font-weight: 500;
}
</style>

@code {
    // ================= VARIABLES =================
    string newPassword = "";           // Stores new password input
    string securityMessage = "";       // Displays password change success/error
    string exportMessage = "";         // Displays PDF export status
    bool useDataRange = false;         // Toggle for filtering export by date
    DateTime startDate = DateTime.Today.AddDays(-7); // Default start date
    DateTime endDate = DateTime.Today;               // Default end date
    string deleteMessage = "";          // Displays deletion status

    // ================= THEME TOGGLE =================
    void ToggleTheme()
    {
        ThemeService.ToggleTheme(); // Switch between dark/light mode
    }

    // ================= CHANGE PASSWORD =================
    async Task ChangePassword()
    {
        if (string.IsNullOrWhiteSpace(newPassword))
        {
            securityMessage = "Password cannot be empty";
            return;
        }

        // Call SecurityService to change password
        var success = await SecurityService.ChangePasswordAsync(newPassword);
        securityMessage = success ? "Password changed successfully" : "Failed to change password";

        newPassword = ""; // Clear input field
    }

    // ================= EXPORT PDF =================
    async Task ExportPdf()
    {
        try
        {
            exportMessage = "Starting export...";
            StateHasChanged();

            // Get all entries for export
            var allEntries = await EntryService.GetAllEntriesForExportAsync() ?? new List<JournalEntry>();

            // Filter by date range if option enabled
            var entries = useDataRange
                ? allEntries.Where(e => e.EntryDate.Date >= startDate.Date && e.EntryDate.Date <= endDate.Date).ToList()
                : allEntries;

            if (!entries.Any())
            {
                exportMessage = "No entries found to export";
                return;
            }

            exportMessage = $"Generating PDF for {entries.Count} entries...";
            StateHasChanged();

            // Generate PDF bytes
            byte[] pdfBytes = PdfService.ExportEntriesToPdf(entries, useDataRange ? startDate : null, useDataRange ? endDate : null);

            // Prepare file path
            var fileName = useDataRange
                ? $"Journal_{startDate:yyyyMMdd}_{endDate:yyyyMMdd}.pdf"
                : $"Journal_AllEntries_{DateTime.Now:yyyyMMdd}.pdf";

            var desktopFolder = Path.Combine(Environment.GetFolderPath(Environment.SpecialFolder.Desktop), "jornapppdf");

            if (!Directory.Exists(desktopFolder))
                Directory.CreateDirectory(desktopFolder);

            var filePath = Path.Combine(desktopFolder, fileName);

            // Save PDF
            await File.WriteAllBytesAsync(filePath, pdfBytes);

            // Open PDF automatically
            await Launcher.OpenAsync(filePath);

            exportMessage = $" PDF saved and opened at: {filePath}";
        }
        catch (Exception ex)
        {
            exportMessage = $" Export failed: {ex.Message}";
        }
    }

    // ================= DELETE OLD ENTRIES =================
    async Task DeleteOrphanedEntries()
    {
        try
        {
            await EntryService.DeleteOrphanedEntriesAsync();
            deleteMessage = " Old entries deleted! Create new entries and they will export correctly.";
        }
        catch (Exception ex)
        {
            deleteMessage = $" Error: {ex.Message}";
        }
    }

    // ================= THEME CHANGE EVENT =================
    protected override void OnInitialized()
    {
        // Subscribe to theme changes so the page updates automatically
        ThemeService.OnThemeChanged += StateHasChanged;
    }

    public void Dispose()
    {
        // Unsubscribe from theme changes to prevent memory leaks
        ThemeService.OnThemeChanged -= StateHasChanged;
    }
}
