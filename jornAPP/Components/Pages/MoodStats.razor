@page "/moodstats"
@using jornAPP.Components.Models
@using jornAPP.Services
@inject JournalService JournalService
@inject NavigationManager NavigationManager
@inject ThemeService ThemeService

<div class="stats-container @(ThemeService.IsDark ? "dark-theme" : "light-theme")">

    <!-- Top Navigation -->
    <nav class="top-nav">
        <button class="btn-nav" @onclick="GoToHome">ğŸ  Home</button>
        <button class="btn-nav" @onclick="GoToEntries">ğŸ“– Entries</button>
        <button class="btn-nav" @onclick="GoToAddEntry">ğŸ“ Add Entry</button>
        <button class="btn-nav" @onclick="GoToAnalytics">ğŸ“Š Analytics</button>
    </nav>

    <h1 class="page-title">ğŸ“Š Mood Analytics</h1>
    <p class="subtitle">Track your emotions and journal habits over time.</p>

    <!-- Mood Distribution Pie Chart -->
    <div class="card">
        <h2>ğŸ˜Š Mood Distribution</h2>
        <svg viewBox="-1 -1 2 2" style="transform: rotate(-90deg)" width="300" height="300">
            @foreach (var slice in MoodSlices)
            {
                <path d="@GetArcPath(slice.StartAngle, slice.EndAngle)" fill="@slice.Color"></path>
            }
        </svg>
        <ul>
            @foreach (var slice in MoodSlices)
            {
                <li style="color:@slice.Color">@slice.Label: @slice.Count</li>
            }
        </ul>
    </div>

    <!-- Category Distribution Pie Chart -->
    <div class="card">
        <h2>ğŸ¯ Category Distribution</h2>
        <svg viewBox="-1 -1 2 2" style="transform: rotate(-90deg)" width="300" height="300">
            @foreach (var slice in CategorySlices)
            {
                <path d="@GetArcPath(slice.StartAngle, slice.EndAngle)" fill="@slice.Color"></path>
            }
        </svg>
        <ul>
            @foreach (var slice in CategorySlices)
            {
                <li style="color:@slice.Color">@slice.Label: @slice.Count</li>
            }
        </ul>
    </div>

    <!-- Streaks -->
    <div class="card">
        <h2>ğŸ”¥ Streaks</h2>
        <p>Current Streak: <strong>@currentStreak</strong> days</p>
        <p>Longest Streak: <strong>@longestStreak</strong> days</p>
    </div>

    <!-- Back Buttons -->
    <div class="back-button-container">
        <button class="btn-back" @onclick="GoToEntries">â† Back to Entries</button>
        <button class="btn-back" @onclick="GoToHome">â† Back to Home</button>
    </div>
</div>

<style>
.stats-container { max-width: 900px; margin: 50px auto; padding: 20px; font-family: 'Segoe UI', sans-serif; }
.top-nav { display: flex; justify-content: center; gap: 15px; flex-wrap: wrap; margin-bottom: 30px; }
.btn-nav { background: #ffd700; color: #121212; border: none; padding: 10px 22px; border-radius: 12px; font-weight: 700; cursor: pointer; }
.btn-nav:hover { opacity: 0.85; transform: translateY(-2px); }
.page-title { font-size: 2.5rem; text-align: center; color: #ffd700; margin-bottom: 5px; }
.subtitle { text-align: center; color: #e0e0e0; font-size: 1.1rem; margin-bottom: 30px; }
.card { background: #141414; border-radius: 16px; padding: 28px 30px; margin-bottom: 28px; box-shadow: 0 12px 30px rgba(255, 204, 0, 0.6); color: #fff; text-align: center; }
.card h2 { color: #ffd700; margin-bottom: 16px; }
.card p { font-size: 1.2rem; margin: 6px 0; }
.card p strong { color: #ffd700; font-size: 1.4rem; }
.card ul { list-style: none; padding: 0; margin-top: 10px; }
.card ul li { font-size: 1.1rem; margin: 4px 0; }
.back-button-container { display: flex; justify-content: center; gap: 15px; margin-top: 40px; flex-wrap: wrap; }
.btn-back { background: #121212; color: #ffd700; border: 2px solid #ffd700; padding: 12px 26px; border-radius: 12px; cursor: pointer; }
.btn-back:hover { background: #ffd700; color: #121212; }
.dark-theme { background-color: #0b0b0b; color: #f5f5f5; }
.light-theme { background-color: #ffffff; color: #111111; }
</style>

@code {
    private List<JournalEntry> entries = new();
    private List<PieSlice> MoodSlices = new();
    private List<PieSlice> CategorySlices = new();
    private int currentStreak;
    private int longestStreak;

    protected override async Task OnInitializedAsync()
    {
        entries = await JournalService.GetAllEntriesAsync();

        PrepareMoodSlices();
        PrepareCategorySlices();
        CalculateStreaks();
    }

    private void PrepareMoodSlices()
    {
        var moods = new[] { "ğŸ˜Š Happy", "ğŸ˜Œ Calm", "ğŸ˜ Okay", "ğŸ˜” Sad", "ğŸ˜¤ Stressed" };
        var colors = new[] { "#4caf50", "#2196f3", "#ff9800", "#9c27b0", "#f44336" };
        int total = entries.Count;
        double startAngle = 0;

        MoodSlices = moods.Select((m, i) =>
        {
            int count = entries.Count(e => e.PrimaryMood == m);
            double angle = total == 0 ? 0 : (double)count / total * 360;
            var slice = new PieSlice
            {
                Label = m,
                Count = count,
                Color = colors[i],
                StartAngle = startAngle,
                EndAngle = startAngle + angle
            };
            startAngle += angle;
            return slice;
        }).ToList();
    }

    private void PrepareCategorySlices()
    {
        var categories = new[] { "Positive", "Neutral", "Negative" };
        var colors = new[] { "#4caf50", "#ff9800", "#f44336" };
        int total = entries.Count;
        double startAngle = 0;

        CategorySlices = categories.Select((c, i) =>
        {
            int count = entries.Count(e => e.Category == c);
            double angle = total == 0 ? 0 : (double)count / total * 360;
            var slice = new PieSlice
            {
                Label = c,
                Count = count,
                Color = colors[i],
                StartAngle = startAngle,
                EndAngle = startAngle + angle
            };
            startAngle += angle;
            return slice;
        }).ToList();
    }

    private void CalculateStreaks()
    {
        if (!entries.Any()) return;
        var dates = entries.Select(e => e.EntryDate.Date).Distinct().OrderBy(d => d).ToList();
        int streak = 1;
        currentStreak = 1;
        longestStreak = 1;
        for (int i = 1; i < dates.Count; i++)
        {
            if ((dates[i] - dates[i - 1]).Days == 1)
            {
                streak++;
                currentStreak = streak;
                longestStreak = Math.Max(longestStreak, streak);
            }
            else streak = 1;
        }
    }

    private string GetArcPath(double startAngle, double endAngle)
    {
        double rad(double deg) => deg * Math.PI / 180;
        double x1 = Math.Cos(rad(startAngle));
        double y1 = Math.Sin(rad(startAngle));
        double x2 = Math.Cos(rad(endAngle));
        double y2 = Math.Sin(rad(endAngle));
        bool largeArc = endAngle - startAngle > 180;
        return $"M 0 0 L {x1} {y1} A 1 1 0 {(largeArc ? 1 : 0)} 1 {x2} {y2} Z";
    }

    private void GoToHome() => NavigationManager.NavigateTo("/");
    private void GoToEntries() => NavigationManager.NavigateTo("/entries");
    private void GoToAddEntry() => NavigationManager.NavigateTo("/addentry");
    private void GoToAnalytics() => NavigationManager.NavigateTo("/analytics");

    public class PieSlice
    {
        public string Label { get; set; } = "";
        public int Count { get; set; }
        public string Color { get; set; } = "#4caf50";
        public double StartAngle { get; set; }
        public double EndAngle { get; set; }
    }
}
