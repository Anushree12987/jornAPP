@page "/analytics"
@using jornAPP.Components.Models
@using jornAPP.Services
@inject JournalService JournalService

<div class="analytics-container">

    <h1>üìä Your Journal Analytics</h1>
    <p class="subtitle">Insights based on your past entries</p>

    @if (!allEntries.Any())
    {
        <p class="empty">No entries yet.</p>
    }
    else
    {
        <!-- üìå SUMMARY BOX -->
        <div class="summary-card">
            <h2>üìå Summary</h2>
            <p><span>Most Frequent Mood</span> @mostFrequentMood</p>
            <p><span>Total Entries</span> @allEntries.Count</p>
            <p><span>Total Words Written</span> @totalWords</p>
            <p><span>Average per Entry</span> @Math.Round(avgWordCount, 0)</p>
            <p><span>Missed Days</span> @missedDays</p>
            <p><span>Most Used Tag</span> @mostUsedTag</p>


        </div>

        <!-- üìä DISTRIBUTION -->
        <div class="grid">
            <div class="card">
                <h3>üòä Mood Distribution</h3>
                <ul>
                    @foreach (var m in moodCounts)
                    {
                        <li>@m.Mood <span>@m.Count</span></li>
                    }
                </ul>
            </div>
            <div class="card">
                <h3>üè∑Ô∏è Tag Usage</h3>

                @if (!tagCounts.Any())
                {
                    <p class="empty">No tags used yet.</p>
                }
                else
                {
                    <ul>
                        @foreach (var t in tagCounts)
                        {
                            <li>@t.Tag <span>@t.Count</span></li>
                        }
                    </ul>
                }
            </div>


            <div class="card">
                <h3>üéØ Category Distribution</h3>
                <ul>
                    @foreach (var c in categoryCounts)
                    {
                        <li>@c.Category <span>@c.Count</span></li>
                    }
                </ul>
            </div>
        </div>
    }
</div>

<style>
/* üåë PAGE */
.analytics-container {
    min-height: 100vh;
    padding: 30px 20px;
    background-color: transparent;
    color: var(--text-color);
    font-family: 'Segoe UI', sans-serif;
}

/* HEADER */
.analytics-container h1 {
    text-align: center;
    color: #ffcc00;
    margin-bottom: 6px;
}

.subtitle {
    text-align: center;
    color: #aaa;
    margin-bottom: 28px;
}

.empty {
    text-align: center;
    color: #888;
}

/* üìå SUMMARY */
.summary-card {
    max-width: 700px;
    margin: 0 auto 36px;
    padding: 22px;
    border-radius: 18px;
    background: linear-gradient(135deg, #000000, #1a1a1a);
    border-left: 6px solid #ffcc00;
    box-shadow: 0 8px 28px rgba(255, 204, 0, 0.15);
}

.summary-card h2 {
    color: #ffcc00;
    margin-bottom: 14px;
}

.summary-card p {
    display: flex;
    justify-content: space-between;
    margin: 8px 0;
    font-size: 16px;
}

.summary-card span {
    color: #aaa;
}

/* GRID */
.grid {
    max-width: 900px;
    margin: auto;
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
    gap: 22px;
}

/* CARDS */
.card {
    background: #121212;
    border-radius: 16px;
    padding: 20px;
    border: 1px solid rgba(255, 204, 0, 0.5);
    box-shadow: 0 6px 20px rgba(255, 204, 0, 0.12);
}

.card h3 {
    color: #ffcc00;
    margin-bottom: 14px;
}

/* LIST */
.card ul {
    list-style: none;
    padding: 0;
}

.card li {
    display: flex;
    justify-content: space-between;
    padding: 10px 0;
    border-bottom: 1px solid rgba(255, 204, 0, 0.25);
    font-size: 15px;
}

.card li span {
    font-weight: bold;
    color: #ffcc00;
}
</style>

@code {
    List<JournalEntry> allEntries = new();
    List<(string Mood, int Count)> moodCounts = new();
    List<(string Category, int Count)> categoryCounts = new();
    List<TagInfo> tagCounts = new();
    
    string mostUsedTag = "";
    string mostFrequentMood = "";
    int totalWords = 0;
    double avgWordCount = 0;
    int missedDays = 0;


    protected override async Task OnInitializedAsync()
    {
        allEntries = await JournalService.GetAllEntriesAsync();

        if (!allEntries.Any())
            return;

        ComputeMoodData();
        ComputeCategoryData();
        ComputeWordData();
        ComputeMissedDays();
        ComputeTagData();  
    }

    void ComputeMoodData()
    {
        moodCounts = allEntries
            .Select(e => string.IsNullOrWhiteSpace(e.PrimaryMood) ? "Unknown" : e.PrimaryMood.Trim())
            .GroupBy(m => m)
            .Select(g => (Mood: g.Key, Count: g.Count()))
            .OrderByDescending(g => g.Count)
            .ToList();

        mostFrequentMood = moodCounts.First().Mood;
    }
   
    void ComputeCategoryData()
    {
        categoryCounts = allEntries
            .Select(e => string.IsNullOrWhiteSpace(e.Category) ? "Unknown" : e.Category.Trim())
            .GroupBy(c => c)
            .Select(g => (Category: g.Key, Count: g.Count()))
            .ToList();
    }

    void ComputeWordData()
    {
        var wordCounts = allEntries
            .Where(e => !string.IsNullOrWhiteSpace(e.Content))
            .Select(e => e.Content.Split(' ', StringSplitOptions.RemoveEmptyEntries).Length);

        totalWords = wordCounts.Sum();
        avgWordCount = wordCounts.Any() ? wordCounts.Average() : 0;
    }
    void ComputeMissedDays()
    {
        var dates = allEntries
            .Select(e => e.EntryDate.Date)
            .Distinct()
            .OrderBy(d => d)
            .ToList();

        if (dates.Count < 2)
        {
            missedDays = 0;
            return;
        }

        var startDate = dates.First();
        var endDate = dates.Last();

        int totalDays = (endDate - startDate).Days + 1;
        int writtenDays = dates.Count;

        missedDays = totalDays - writtenDays;
    }
    void ComputeTagData()
    {
        tagCounts = allEntries
            .Where(e => !string.IsNullOrWhiteSpace(e.Tags))
            .SelectMany(e => e.Tags
                .Split(',', StringSplitOptions.RemoveEmptyEntries)
                .Select(t => t.Trim()))
            .GroupBy(t => t)
            .Select(g => new TagInfo
            {
                Tag = g.Key,
                Count = g.Count()
            })
            .OrderByDescending(t => t.Count)
            .ToList();

        mostUsedTag = tagCounts.Any() ? tagCounts.First().Tag : "";
    }

}
